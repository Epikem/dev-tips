# TIL 2020-07-20

ì˜¤ëŠ˜ ë°°ìš´ ê²ƒ & í•œ ê²ƒ

--------------------------

## ì–´ì œ í•œ ì¼
- [x] êµ¬ê¸€/ì• í”Œ api ìƒì„¸ ë¶„ì„ì¤‘
- [x] ê¸°ëŠ¥ ë¶„ì„, ì„¤ê³„ë¬¸ì„œ ì‘ì„±ì¤‘

- [x] ë°°ìŠ¤ì²œ í˜¸ìŠ¤íŠ¸ êµ¬ì¡° ì •ë¦¬í•˜ê¸°

## í•  ì¼

**ì¤‘ìš”**
- [ ] êµ¬ê¸€/ì• í”Œ api ìƒì„¸ ë¶„ì„
- [ ] ê¸°ëŠ¥ ë¶„ì„, ì„¤ê³„ë¬¸ì„œ ì‘ì„±

- [x] gitlab ci/cd íŒŒì´í”„ë¼ì¸ êµ¬ì¶•
- [ ] ë°°ìŠ¤ì²œ í˜¸ìŠ¤íŠ¸ êµ¬ì¡° ìƒì„¸ë¬¸ì„œ ì‘ì„±
- [x] backup the structure using cloudformer and cloudformation
- [x] make password protected s3 bucket and manage keys in there

- [ ] uml ì‹œë‚˜ë¦¬ì˜¤ ì‘ì„±
- [ ] ì˜ˆì™¸ì‚¬ë¡€ ìƒê°í•˜ê¸° (spoof, ddos ë“±)
- [x] aws configure script ì‘ì„±

### 
- [ ] cloudformer ì‚¬ìš©ë¶ˆê°€ - ë””ë”¤ë‚˜ìš° ë¬¸ì˜ otp ì¸ì¦ í•„ìš”

## ë°°ìš´ ê²ƒ & í•œê²ƒ 

ì˜ë¬¸ì  : ì•„ë˜ íŒŒì´í”„ë¼ì¸ êµ¬ì¶• ë° ë¬¸ì„œì‘ì—…ê³¼ ê°™ì€ ë¶€ë¶„ë„ ì—…ë¬´íë¦„ë„ì— ë“¤ì–´ê°€ëŠ”ê°€?

### gitlab ci/cd íŒŒì´í”„ë¼ì¸ êµ¬ì¶•

ì½”ë“œëŠ” gitlabì—ì„œ ì‘ì„±í•˜ê³  awsì— ì˜¬ë ¤ì„œ ë™ì‘í•˜ëŠ” ì‹ìœ¼ë¡œ í•œë‹¤ë©´, í…ŒìŠ¤íŠ¸ í•˜ê³  ë¹Œë“œí•´ì„œ í´ë¼ìš°ë“œì— ì˜¬ë¦¬ëŠ” ê³¼ì •ì„ ì–´ë””ì— ë„£ì–´ì•¼ í•˜ëŠ”ê°€?

https://docs.gitlab.com/ee/ci/cloud_deployment/
ì—¬ê¸°ë¥¼ ë³´ë©´ awsì™€ ì—°ë™ì´ ê°€ëŠ¥í•œ ê²ƒìœ¼ë¡œ ë³´ì´ê¸´ í•œë‹¤. ê·¸ëŸ°ë° credential configureê°€ í•„ìš”í•œ ëª¨ì–‘ì´ë‹¤.

```yaml
deploy:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest # see the note below
  script:
    - aws s3 ...
    - aws create-deployment ...
```
ì € `script`ë¶€ë¶„ì— ë“¤ì–´ê°€ëŠ” ê²ƒì´ ëŒ€ëµ CLI ì»¤ë§¨ë“œ ëª…ë ¹ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤. ê·¸ë ‡ë‹¤ë©´ ë³µì¡í•œ êµ¬ì¡°ë¥¼ ë§Œë“œë ¤ë©´ `cloudformation.yaml`ì— êµ¬ì¡°ë¥¼ ì •ì˜í•´ë‘ê³  ìœ„ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í˜¸ì¶œí•´ì„œ ë§Œë“¤ë„ë¡ í•˜ëŠ” ê²ƒì´ í˜„ì‹¤ì ì¼ ê²ƒì´ë‹¤. ê·¸ë ‡ë‹¤ë©´ ì‚­ì œëŠ” ì–´ë–»ê²Œ í•˜ë‚˜??
ì¼ë‹¨ ê°„ë‹¨í•œ ë¦¬ì†ŒìŠ¤ ëª‡ ê°œë¥¼ ë§Œë“¤ì–´ì„œ í…ŒìŠ¤íŠ¸í•´ë³´ì.

ê·¸ì™¸ ci/cd ì˜ˆì œë“¤: https://docs.gitlab.com/ee/ci/examples/
node js: https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Nodejs.gitlab-ci.yml


### aws configure script ì‘ì„±

ê³„ì •ë“¤ê³¼ credentialë“¤ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ë° íŒ€ì›ì—ê²Œ ê³µìœ ê°€ í•„ìš”í•˜ë‹¤.

#### make password protected s3 bucket and manage keys in there
ref : 
- https://docs.aws.amazon.com/cli/latest/reference/s3/presign.html
- https://docs.aws.amazon.com/AmazonS3/latest/dev/ShareObjectPreSignedURL.html

<details><summary markdown="span">ì‚½ì§ˆ</summary>

ì—¬ê¸° ë‚˜ì˜¨ëŒ€ë¡œ í•´ì„œ `aws s3 presign s3://<bucket>/<file>` í˜•ì‹ìœ¼ë¡œ í•˜ë‹ˆ httpsì£¼ì†Œê°€ ë‚˜ì˜¤ê¸¸ë˜ ì ‘ì†í–ˆëŠ”ë° ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ í˜ì´ì§€ê°€ ë–´ë‹¤.

```xml
<Error>
<Code>AccessDenied</Code>
<Message>Access Denied</Message>
<RequestId>CFBA23552824415B</RequestId>
<HostId>
fkxHJx19sPq1S+HTSQvL1EWghNNDTMTmHJocmP0wpwd/0V5fzZ35voGCZOA63jiuUbfHHnRyASo=
</HostId>
</Error>
```

ì•Œê³ ë³´ë‹ˆ credential íŒŒì¼ì— ë¬¸ë²• ì—ëŸ¬ê°€ ìˆì–´ì„œ ë¡œê·¸ì¸ì´ ì•ˆë˜ëŠ” ìƒíƒœì˜€ë‹¤. ë°”ê¾¸ê³  ë˜‘ê°™ì´ í•˜ë‹ˆ ë˜ì—ˆë‹¤.

</details>

ì—¬ê¸° ë‚˜ì˜¨ëŒ€ë¡œ `aws s3 presign s3://<bucket>/<file>` í˜•ì‹ìœ¼ë¡œ í•˜ë©´ ëœë‹¤.

`--expires-in <value in seconds>` ì˜µì…˜ìœ¼ë¡œ ê¸°ê°„ì„ ì¤„ ìˆ˜ ìˆë‹¤. ê¸°ë³¸ê°’ì€ 3600ì´ˆ.

#### make aws named profile
ì°¸ì¡° : https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html

credentials ì •ë³´ëŠ” `~/.aws/credentials` íŒŒì¼ì—, config ì •ë³´ëŠ” `~/.aws/config` íŒŒì¼ì— ì €ì¥ëœë‹¤. ê·¸ëŸ°ë° ë‘ íŒŒì¼ì˜ í”„ë¡œí•„ ì‘ì„± í˜•ì‹ì´ ì¡°ê¸ˆ ë‹¤ë¥´ë¯€ë¡œ ì£¼ì˜í•´ì•¼ í•œë‹¤.

> ğŸ“‚ `~/.aws/credentials`
```yaml
[default]
aws_access_key_id = <aws_access_key_id>
aws_secret_access_key = <aws_secret_access_key>

[epikem]
aws_access_key_id = <aws_access_key_id>
aws_secret_access_key = <aws_secret_access_key>
```

> ğŸ“‚ `~/.aws/config.`
```yaml
[default]
region = ap-northeast-2
output = yaml

[profile epikem]
region = ap-northeast-2
output = yaml
```

ì´ë ‡ë“¯ ê¸°ë³¸ í”„ë¡œí•„ì´ ì•„ë‹Œ í”„ë¡œí•„ì€ `config`ì—ì„œëŠ” `[profile <profile name>]` í˜•ì‹ìœ¼ë¡œ ì‹œì‘í•´ì•¼ í•œë‹¤.

### backup the structure using cloudformer and cloudformation
(ì§„í–‰ì¤‘)

ê²°êµ­ ìˆ˜ì‘ì—…ìœ¼ë¡œ í´ë¼ìš°ë“œí¬ë©”ì´ì…˜í™”ë¥¼ í•˜ê³  ìˆë‹¤. cfn-skeletonìœ¼ë¡œ ëª¨ë“  ì˜µì…˜ì„ ê°€ì§„ í…œí”Œë¦¿ì„ ë§Œë“  í›„ í•˜ë‚˜ì”© ë°”ê¾¸ëŠ” ì‹ìœ¼ë¡œ í•˜ê³  ìˆë‹¤.

ë‚˜ì¤‘ì— autoscalingê³¼ loadbalancingì„ ì‚¬ìš©í•˜ë ¤ë©´ launch templateë¥¼ ì‚¬ìš©í•´ì•¼ í•  ë“¯. autoscaling, loadbalancing, cloudwatch ì´ ì„¸ê°€ì§€ ì„œë¹„ìŠ¤ë¥¼ ë³´í†µ ê°™ì´ ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤.
ì°¸ì¡°:
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-launchtemplate-launchtemplatedata.html
- https://www.edureka.co/community/49245/difference-between-working-of-auto-scaling-and-elb
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/quickref-autoscaling.html

ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ë ¤ í•˜ë‹ˆ availibility zoneì—ì„œ í•´ë‹¹ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ë‹¤ëŠ” ì—ëŸ¬ê°€ ë‚¬ë‹¤ ì•„ë¬´ë˜ë„ subnetì˜ ê°€ìš©ì˜ì—­ê³¼ ì—°ê²°ì´ ì•ˆë˜ì–´ì„œ ê·¸ëŸ° ë“¯í•´ì„œ ì°¾ì•„ë³´ë‹ˆ ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ì˜ ì†ì„±ì„ ì°¸ì¡°í•  ìˆ˜ ìˆëŠ” ë¬¸ë²•ì´ ìˆì—ˆë‹¤:
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-getatt.html 
```yaml
# Syntax for the full function name:
Fn::GetAtt: [ logicalNameOfResource, attributeName ]

# Syntax for the short form:
!GetAtt logicalNameOfResource.attributeName
```

ê·¸ë ‡ê²Œ í–ˆëŠ”ë°ë„ ë‹¤ì‹œ ì—ëŸ¬ê°€ ë‚¬ë‹¤. ì•„ë¬´ë˜ë„ subnetë¶€í„°ê°€ ì˜ëª»ëœ ê°€ìš©ì˜ì—­ì„ ì§€ì •í•´ë²„ë ¤ì„œ ê·¸ëŸ°ì§€ë„ ëª¨ë¥´ê² ë‹¤. ê·¸ë ‡ë‹¤ë©´ ì•„ë¬´ ê°€ìš©ì˜ì—­ì´ë‚˜ ê°€ëŠ¥í•˜ê²Œ í•˜ë˜ê°€ ì•„ë‹ˆë©´ ì›í•˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì„ ì‚¬ìš© ê°€ëŠ¥í•œ ê°€ìš©ì˜ì—­ì„ ì§€ì •í•˜ë„ë¡ í•´ì•¼ í•  ê²ƒì´ë‹¤. ë‹¤ìŒ í˜ì´ì§€ì—ì„œ ê·¸ëŸ¬í•œ ëª…ë ¹ì–´ ì‚¬ìš©ë²•ì„ ì•Œë ¤ì¤€ë‹¤.
- https://aws.amazon.com/ko/premiumsupport/knowledge-center/ec2-instance-type-not-supported-az-error/

`aws ec2 describe-instance-type-offerings` ëª…ë ¹ì„ í†µí•´ ì•Œ ìˆ˜ ìˆë‹¤.
`--region` ì˜µì…˜ì„ ë¹¼ë©´ ê¸°ë³¸ ë¦¬ì „ìœ¼ë¡œ ì•Œë ¤ì¤€ë‹¤.

```
$ aws ec2 describe-instance-type-offerings --location-type availability-zone  --filters Name=instance-type,Values=t2.micro --output table

------------------------------------------------------------
|               DescribeInstanceTypeOfferings              |
+----------------------------------------------------------+
||                  InstanceTypeOfferings                 ||
|+--------------+-------------------+---------------------+|
|| InstanceType |     Location      |    LocationType     ||
|+--------------+-------------------+---------------------+|
||  t2.micro    |  ap-northeast-2c  |  availability-zone  ||
||  t2.micro    |  ap-northeast-2a  |  availability-zone  ||
|+--------------+-------------------+---------------------+|
```

ê·¸ëŸ¬ë©´ ì–´ë–»ê²Œ íŠ¹ì • ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì´ ê°€ëŠ¥í•œ ê°€ìš©ì˜ì—­ì„ ì°¾ì•„ì„œ ì§€ì •í•˜ê²Œ í•˜ë‚˜? ë°©ë²•ì„ ëª¨ë¥´ê² ë‹¤. í˜„ì¬ëŠ” ì•„ë¬´ë˜ë„ ìœ„ ëª…ë ¹ìœ¼ë¡œ ê°€ìš©ì˜ì—­ì„ ì°¾ì€ ë‹¤ìŒ, cloudformationì˜ [íŒŒë¼ë¯¸í„° ê¸°ëŠ¥](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html)ì„ ì´ìš©í•´ì„œ ê°€ìš©ì˜ì—­ì„ ì§€ì •í•˜ê²Œ í•˜ëŠ”ì‹ìœ¼ë¡œ í•´ì•¼í•  ë“¯ í•˜ë‹¤.

íŒŒë¼ë¯¸í„° ê¸°ëŠ¥ì—ëŠ” ë¬¸ìì—´ë§Œ ì‚¬ìš©ê°€ëŠ¥í•´ì„œ AllowdValuesë¥¼ ì“°ê¸°ê°€ ë²ˆê±°ë¡­ë‹¤. 
ì¼ë‹¨ ê·¸ëƒ¥ defaultë§Œ ì§€ì •í•´ë†“ê³  ì¨ì•¼ê² ë‹¤.
`aws cloudformation create-stack --stack-name stack1 --template-body file://./stack1.yaml --parameters ParameterKey=AZParameter,ParameterValue=ap-northeast-2c`


**aws cloudformation ec2 ëª¨ë²” ì‹œë‚˜ë¦¬ì˜¤:**
- https://aws.amazon.com/ko/blogs/infrastructure-and-automation/best-practices-for-deploying-ec2-instances-with-aws-cloudformation/

ë³´ì•ˆ ì„¤ì •, ì‹œì‘ í›„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì„ í†µí•œ ì¸ìŠ¤í„´ìŠ¤ ì…‹ì—… ë“± ì—¬ëŸ¬ê°€ì§€ë¥¼ ë‹¤ë£¬ë‹¤.
ê½¤ë‚˜ ë³µì¡í•˜ë‹¤. ë‚´ì¼ ì½ì–´ë³´ì.


--------------------------


 